apiVersion: batch/v1
kind: Job
metadata:
  name: rally-es-openai-vector
spec:
  completions: 10
  template:
    metadata:
      name: rally-es-openai-vector
      labels: 
        app: rally-elasticsearch
    spec:
      restartPolicy: Never
      nodeSelector:
        cloud.google.com/gke-nodepool: rally-nodes
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - rally-opensearch
            topologyKey: kubernetes.io/hostname
      tolerations:
        - key: "kubernetes.io/arch"
          operator: "Exists"
          effect: "NoSchedule"
      containers:
        - name: rally
          image: docker.elastic.co/employees/ugosan/rally-custom:115
          imagePullPolicy: Always
          env:
            - name: HOSTPORT
              value: "es-cluster-es-http:9200"
            - name: USERNAME
              value: "elastic"
            - name: PASSWORD
              valueFrom:
                secretKeyRef:
                  name: es-cluster-es-elastic-user
                  key: elastic
            - name: META
              value: "product:Elasticsearch,product-version:Elasticsearch-8.13.0,benchmark-run:vector-1"
          args:
            [
              "race",
              "--track-path=/rally/custom_tracks/elasticsearch/openai_vector",
              "--target-hosts=$(HOSTPORT)",
              "--pipeline=benchmark-only",
              "--user-tags=$(META)",
              "--on-error=abort",
              "--client-options=use_ssl:true,verify_certs:false,basic_auth_user:'$(USERNAME)',basic_auth_password:'$(PASSWORD)'",
              "--challenge=index-and-search",
              "--track-params=vector_index_type:hnsw,number_of_shards:3"
            ]
          volumeMounts:
            - name: rally-config-volume
              mountPath: "/rally/.rally/rally.ini"
              subPath: "rally.ini"
            - name: rally-base-dir
              mountPath: "/rally/.rally"
            - name: rally-tracks-data-es
              mountPath: "/rally-tracks-cache"
          resources:
            requests:
              cpu: "2.1"
            limits:
              cpu: "4"
      imagePullSecrets:
      - name: regcred
      volumes:
        - name: rally-config-volume
          configMap:
            name: rally-config
            items:
              - key: rally.ini
                path: rally.ini
        - name: rally-base-dir
          emptyDir: {}
        - name: rally-tracks-data-es
          persistentVolumeClaim:
            claimName: rally-tracks-data-es
      initContainers:
        - name: permission-fix
          image: busybox
          command: ["sh", "-c"]
          args: ["chmod -R 777 /rally/.rally /rally-tracks-cache"]
          volumeMounts:
            - mountPath: /rally/.rally
              name: rally-base-dir
            - mountPath: /rally-tracks-cache
              name: rally-tracks-data-es
        - name: cleanup-indices
          image: curlimages/curl:8.7.1
          env:
            - name: HOSTPORT
              value: "es-cluster-es-http:9200"
            - name: USERNAME
              value: "elastic"
            - name: PASSWORD
              valueFrom:
                secretKeyRef:
                  name: es-cluster-es-elastic-user
                  key: elastic
          command: ["sh", "-c"]
          args:
            - |
              curl -k -vv -XDELETE "https://$(USERNAME):$(PASSWORD)@$(HOSTPORT)/vectors" &&
              curl -k -vv -XDELETE "https://$(USERNAME):$(PASSWORD)@$(HOSTPORT)/openai" &&
              curl -k -vv -XDELETE "https://$(USERNAME):$(PASSWORD)@$(HOSTPORT)/cohere" 
